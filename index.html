<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tiny PDF - PDF Compressor (Fixed)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- pdf-lib for client-side fallback compression -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
/* --- basic layout --- */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
body{background:#f7f7f7;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{background:linear-gradient(135deg,#2c3e50,#1a2530);color:#fff;padding:18px}
.header-content{width:90%;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;gap:10px;align-items:center}
.logo i{font-size:30px;color:#ff6b6b}
.logo h1{font-size:24px;font-weight:700}
nav ul{display:flex;gap:18px;list-style:none}
nav a{color:#fff;text-decoration:none;padding:6px 8px;border-radius:3px;transition:all .18s}
nav a:hover{background:rgba(255,255,255,0.05);color:#ffb3b3}
.container{width:90%;margin:26px auto;flex:1}

/* --- ads container (matches main container width) --- */
.ads-wrapper{width:100%;margin:18px auto;padding:0}
.ads-container{width:100%;height:250px;background:#fff;border:1px solid #e6e6e6;border-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,0.03);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
.ads-container p{color:#777;font-size:14px;margin:0;padding:8px 10px;z-index:2;text-align:center}
/* placeholder blowhorn */
.ads-placeholder{position:absolute;left:50%;top:48%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:6px;color:#777;pointer-events:none;z-index:3}
.ads-placeholder i{font-size:28px}

/* ensure ad element occupies full area if loaded */
.ads-container ins.adsbygoogle{display:block !important;width:100% !important;height:100% !important;}

/* --- tool styles --- */
.tool-container{background:#fff;border-radius:4px;padding:28px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:30px}
.tool-title{font-size:22px;text-align:center;color:#213042;margin-bottom:12px}
.tool-description{color:#6b7280;text-align:center;margin-bottom:18px}

/* upload area */
.upload-area{border:2px dashed #e6e6e6;padding:34px 18px;border-radius:6px;text-align:center;cursor:pointer;transition:all .16s;background:#fff}
.upload-area.dragover{border-color:#2e86de;background:#fbfdff}
.upload-area i{font-size:44px;color:#2e86de;margin-bottom:10px}
.browse-btn{background:#2e86de;color:#fff;border:0;padding:10px 18px;border-radius:6px;cursor:pointer}
.browse-btn:hover{opacity:.95}

/* options */
.options{margin:18px 0;display:flex;justify-content:center;gap:12px;align-items:center;flex-wrap:wrap}
.options label{font-weight:600;color:#333}
.options input[type=number]{padding:8px;border-radius:6px;border:1px solid #e6e6e6;width:140px}

/* controls */
.compress-btn{background:#10b981;color:#fff;padding:12px;border:0;border-radius:6px;font-weight:600;cursor:pointer;width:100%;margin-top:6px}
.compress-btn:disabled{background:#94a3b8;cursor:not-allowed}

/* status / loading */
.loading{display:none;align-items:center;gap:12px;flex-direction:column;margin-top:16px}
.spinner{width:46px;height:46px;border:5px solid #eee;border-top:5px solid #2e86de;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* result display */
.result{display:none;margin-top:18px;text-align:center}
.file-info{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #f0f0f0;margin-top:8px}
.download-btn{background:#2563eb;color:#fff;padding:10px 18px;border-radius:6px;border:0;cursor:pointer;margin-top:14px}

/* footer */
footer{background:linear-gradient(135deg,#2c3e50,#1a2530);color:#fff;padding:18px;text-align:center;margin-top:30px}
footer a{color:#fff;text-decoration:none;margin:0 6px;transition:color .18s}
footer a:hover{color:#ff6666}
footer a:active{color:red}

/* responsive small screens */
@media (max-width:720px){
  .upload-area{padding:22px}
  .options{flex-direction:column;gap:8px}
  .header-content{width:96%}
  .container{width:96%}
  .ads-container{height:200px}
}
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="logo"><i class="fas fa-file-pdf"></i><h1>Tiny PDF</h1></div>
    <nav><ul><li><a href="#">Nav 1</a></li><li><a href="#">Nav 2</a></li><li><a href="#">Nav 3</a></li></ul></nav>
  </div>
</header>

<div class="container">

  <!-- Responsive Rectangle AdSense Container (250px) -->
  <div class="ads-wrapper">
    <div class="ads-container">
      <div class="ads-placeholder"><i class="fas fa-bullhorn"></i><p>Ads help us provide this service for free</p></div>

      <!-- AdSense block (keeps full area). It will render over placeholder when real ad appears -->
      <ins class="adsbygoogle"
           style="display:block;margin:0"
           data-ad-client="ca-pub-1876390706944654"
           data-ad-slot="2968764212"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>
  </div>

  <!-- TOOL -->
  <section class="tool-container" aria-labelledby="toolTitle">
    <h2 id="toolTitle" class="tool-title">PDF Compressor</h2>
    <p class="tool-description">Upload a PDF — we'll try the server API first; if the API is unavailable we'll compress in your browser.</p>

    <div id="uploadArea" class="upload-area" tabindex="0" title="Drop PDF here or click to select">
      <i class="fas fa-file-upload"></i>
      <div id="uploadText">
        <div>Drag & drop your PDF here</div>
        <div style="margin:8px 0;color:#666">or</div>
        <button type="button" id="browseBtn" class="browse-btn">Select File</button>
      </div>
      <input id="fileInput" type="file" accept="application/pdf" style="display:none">
    </div>

    <div class="options" role="region" aria-label="Compression options">
      <label for="maxSize">Maximum Size (KB)</label>
      <input id="maxSize" type="number" min="50" placeholder="e.g. 200">
    </div>

    <button id="compressBtn" class="compress-btn" disabled>Compress PDF</button>

    <!-- status -->
    <div id="loading" class="loading" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div id="statusText">Waiting...</div>
    </div>

    <!-- result -->
    <div id="result" class="result" aria-live="polite">
      <div style="font-size:18px;font-weight:600;color:#064e3b">Compression completed</div>
      <div class="file-info"><div>Original size</div><div id="originalSize">0 KB</div></div>
      <div class="file-info"><div>Compressed size</div><div id="compressedSize">0 KB</div></div>
      <div class="file-info"><div>Reduction</div><div id="reduction">0%</div></div>
      <button id="downloadBtn" class="download-btn">Download Compressed PDF</button>
    </div>
  </section>

  <section class="about-section">
    <h3 style="margin-bottom:10px;color:#213042">About Tiny PDF</h3>
    <p style="color:#444;line-height:1.6">
      Tiny PDF attempts server-side compression (faster, better quality). If that fails it compresses locally in your browser so the tool works even with network issues.
    </p>
  </section>

</div>

<footer>
  <div>
    <a href="#">About</a> |
    <a href="#">Disclaimer</a> |
    <a href="#">Privacy</a> |
    <a href="#">Terms</a> |
    <a href="#">Contact</a>
  </div>
  <div style="margin-top:8px;font-size:13px;color:#ddd">&copy; 2025 Tiny PDF</div>
</footer>

<script>
/*
  Behavior:
  - Try API first (POST form-data to API_ENDPOINT).
  - If fetch throws or returns non-ok, fallback to client-side using pdf-lib.
  - Shows useful error messages when something fails.
  - Sanitize file name (remove spaces).
*/

const API_ENDPOINT = 'https://api.pdfcompressor.com/compress'; // <-- Replace if your real endpoint differs
const API_KEY = 'yadavsubba2003@gmail.com_MHmwIcyCA0R7zDhvEqjbuYv7TOipbsGaMyF3yxTFZ3aw7Z8BwuH0cN071sJCiNN1';

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const browseBtn = document.getElementById('browseBtn');
const compressBtn = document.getElementById('compressBtn');
const maxSizeInput = document.getElementById('maxSize');
const loading = document.getElementById('loading');
const statusText = document.getElementById('statusText');
const result = document.getElementById('result');
const originalSizeEl = document.getElementById('originalSize');
const compressedSizeEl = document.getElementById('compressedSize');
const reductionEl = document.getElementById('reduction');
const downloadBtn = document.getElementById('downloadBtn');

let uploadedFile = null;
let compressedBlob = null;

// helpers
const formatBytes = bytes => {
  if (bytes < 1024) return bytes + ' bytes';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(2) + ' MB';
};
const sanitizeFileName = name => name.replace(/\s+/g, '_');

// UI bindings
browseBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileSelect);

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  if (e.dataTransfer.files && e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    handleFileSelect();
  }
});

compressBtn.addEventListener('click', () => {
  if (!uploadedFile) return;
  compressBtn.disabled = true;
  runCompression(uploadedFile);
});

downloadBtn.addEventListener('click', () => {
  if (!compressedBlob) return;
  const cleanName = sanitizeFileName(uploadedFile.name).replace(/\.pdf$/i, '') + '_compressed.pdf';
  const url = URL.createObjectURL(compressedBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = cleanName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// file select
function handleFileSelect() {
  if (!fileInput.files || !fileInput.files.length) return;
  const file = fileInput.files[0];
  if (file.type !== 'application/pdf') {
    alert('Please upload a PDF file.');
    return;
  }
  uploadedFile = file;
  compressBtn.disabled = false;

  const name = sanitizeFileName(file.name);
  uploadArea.innerHTML = `<i class="fas fa-file-pdf"></i><div style="margin-top:6px"><strong>${name}</strong></div><div style="color:#666;margin-top:6px">${formatBytes(file.size)}</div><div style="margin-top:10px"><button class="browse-btn" id="changeBtn">Change File</button></div>`;
  const changeBtn = document.getElementById('changeBtn');
  changeBtn.addEventListener('click', () => fileInput.click());
}

// main compression flow
async function runCompression(file) {
  // show loading
  loading.style.display = 'flex';
  statusText.textContent = 'Uploading to server... (attempting API compression)';
  result.style.display = 'none';
  compressedBlob = null;

  const maxSizeKB = maxSizeInput.value ? parseInt(maxSizeInput.value, 10) : null;

  // Attempt API call with timeout
  try {
    const apiResult = await tryApiCompress(file, maxSizeKB, 20000); // 20s timeout
    if (apiResult && apiResult.blob) {
      // success
      compressedBlob = apiResult.blob;
      showResult(file, compressedBlob, 'Server (API) compression used');
      return;
    }
    // if apiResult is falsy, fall through to fallback
    throw new Error('API returned no data');
  } catch (apiErr) {
    // show message then fallback
    console.warn('API compression failed:', apiErr);
    statusText.textContent = 'API failed — compressing locally in your browser...';
    try {
      const localResult = await clientSideCompress(file);
      compressedBlob = localResult;
      showResult(file, compressedBlob, 'Client-side compression used');
    } catch (localErr) {
      console.error('Local compression failed:', localErr);
      alert('Compression failed (both server and local). See console for details.');
    }
  } finally {
    loading.style.display = 'none';
    compressBtn.disabled = false;
  }
}

// Attempt server API compression with timeout and CORS handling (if server supports it)
async function tryApiCompress(file, targetKB = null, timeoutMs = 20000) {
  const form = new FormData();
  form.append('file', file);
  if (targetKB) form.append('target_size_kb', targetKB);

  // create an abortable fetch (timeout)
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const resp = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + API_KEY
        // do not set Content-Type - browser will set proper multipart boundary
      },
      body: form,
      signal: controller.signal
    });

    clearTimeout(id);

    if (!resp.ok) {
      const text = await resp.text().catch(()=>'<no-body>');
      throw new Error(`Server returned ${resp.status}: ${text}`);
    }

    // Expect a binary (application/pdf)
    const contentType = resp.headers.get('content-type') || '';
    if (!contentType.includes('pdf') && !contentType.includes('application/octet-stream')) {
      // maybe the API returns JSON with error
      const txt = await resp.text();
      throw new Error('Unexpected server response: ' + txt);
    }

    const blob = await resp.blob();
    return { blob };
  } catch (err) {
    // network error / timeout / CORS / server error
    throw err;
  }
}

// Client-side fallback using pdf-lib (best-effort)
async function clientSideCompress(file) {
  // strategy:
  // - load file as ArrayBuffer
  // - use PDFLib.PDFDocument.load
  // - save with compress:true and useObjectStreams:true
  // Note: this compresses object streams and may help, but it's not a pixel-level image re-encode.
  // For stronger compression we'd rasterize pages (heavy) — pdf-lib's compress often suffices.
  const arr = await file.arrayBuffer();

  // load doc
  const pdfDoc = await PDFLib.PDFDocument.load(arr, { ignoreEncryption: true });

  // Optionally: try to reduce image sizes by re-embedding images at lower quality.
  // Implementing pixel-level image recompression is complex and heavy; this simple path uses builtin compress.
  const pdfBytes = await pdfDoc.save({ useObjectStreams: true, compress: true });

  // create blob
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  return blob;
}

// show result
function showResult(originalFile, blob, message) {
  originalSizeEl.textContent = formatBytes(originalFile.size);
  compressedSizeEl.textContent = formatBytes(blob.size);
  const percent = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(1);
  reductionEl.textContent = (isFinite(percent) ? percent + '%' : '0%');

  // set compressed blob for download
  compressedBlob = blob;

  // update status
  result.style.display = 'block';
  statusText.textContent = message;
}

// Accessibility: keyboard 'Enter' triggers upload area click
uploadArea.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    fileInput.click();
  }
});
</script>
</body>
</html>
